import { updatePosts, loadMore, getLatestPosts } from '@firebase/client'
import { HeaderMobile } from 'components/Utils/HeaderMobile'
import { PostCard } from 'components/Posts/PostCard'
import { useAuth } from 'context/authUserContext'
import Head from 'next/head'
import { SyntheticEvent, useEffect, useRef, useState } from 'react'
import { PostCollection } from 'types/databaseTypes'
import { DocumentData, QueryDocumentSnapshot } from 'firebase/firestore'
import { Spinner } from 'flowbite-react'
import { CreatePostModal } from 'components/Modal/CreatePostModal'
import { MainPageLayout } from 'components/Utils/MainPageLayout'
import { PageContenLayout } from 'components/Utils/PageContenLayout'

export default function Home () {
  const [search, setSearch] = useState('')
  const [posts, setPosts] = useState<PostCollection[]>([])
  const [upcomingPosts, setUpcomingPosts] = useState<PostCollection[]>([])
  const [lastPost, setLastPost] = useState<QueryDocumentSnapshot<DocumentData>>()
  const [isSincronized, setIsSincronized] = useState(true)
  const [loading, setLoading] = useState(false)
  const [showModal, setShowModal] = useState(false)
  const listRef = useRef<HTMLElement>(null)
  const auth = useAuth()

  useEffect(() => {
    setLoading(true)
    if (auth.authUser) {
      getLatestPosts().then(({ lastPost, newPosts }) => {
        setPosts(newPosts)
        setLastPost(lastPost)
        setLoading(false)
        setIsSincronized(true)
      })
      const unsub = updatePosts(setUpcomingPosts)
      return () => unsub && unsub()
    }
  }, [auth.authUser])

  useEffect(() => {
    if (upcomingPosts[0]?.id !== posts[0]?.id || upcomingPosts.length !== posts.length) {
      setIsSincronized(false)
    }
  }, [upcomingPosts])

  const handleScroll = (e: SyntheticEvent) => {
    const { scrollTop, clientHeight, scrollHeight } = e.currentTarget
    listRef.current?.focus()

    if (scrollTop + clientHeight > scrollHeight - 20 && !loading) {
      setLoading(true)
      lastPost && loadMore(lastPost).then(({ lastPost, newPosts }) => {
        setLastPost(lastPost)
        setPosts(prev => [...prev, ...newPosts])
        setLoading(false)
      })
    }
  }

  const handleUpdatePosts = () => {
    setPosts(upcomingPosts)
    setIsSincronized(true)
    listRef.current?.scrollTo(0, 0)
  }

  return (
    <>
      <Head>
        <title>Connet</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="logo_ico.ico" />
      </Head>
      <MainPageLayout>
        <HeaderMobile search={search} setSearch={setSearch}/>
        <PageContenLayout handleRef={listRef} handleScroll={handleScroll}>
          <button onClick={() => setShowModal(true)} className='w-3/5 bg-dark-green text-ligth-text-green rounded-full hidden md:block font-concert-one pb-2 hover:opacity-80 transition-opacity' id='btnCreatePostDesktop'>Create post</button>

          {
            !isSincronized && <button className='fixed md:sticky z-20 bg-dark-green rounded-lg text-ligth-text-green font-concert-one px-2 py-1 w-2/4 left-1/2 transform -translate-x-1/2 top-28 sm:w-1/4 md:top-0 md:pb-3 hover:opacity-80 transition-opacity' id='btnUpdateFeed' onClick={handleUpdatePosts}>Update</button>
          }

          {
            posts && posts.map(post => {
              if (post.content?.toLowerCase().includes(search)) {
                return <PostCard
                post={post}
                key={post.id}
                />
              }
              return undefined
            })
          }

          {
            loading && <Spinner color={'gray'}/>
          }

        </PageContenLayout>
      </MainPageLayout>

      <CreatePostModal setShowModal={setShowModal} showModal={showModal} formId='create-post-desktop'/>
    </>
  )
}
