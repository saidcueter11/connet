import { updatePosts, loadMore, getLatestPosts } from '@firebase/client'
import { HeaderMobile } from 'components/Utils/HeaderMobile'
import { NavBarMobile } from 'components/Utils/NavBarMobile'
import { PostCard } from 'components/Posts/PostCard'
import { useAuth } from 'context/authUserContext'
import Head from 'next/head'
import { SyntheticEvent, useEffect, useState } from 'react'
import { PostCollection } from 'types/databaseTypes'
import { SideBarContainer } from 'components/SideBars/SideBarContainer'
import { DocumentData, QueryDocumentSnapshot } from 'firebase/firestore'
import { Spinner } from 'flowbite-react'

export default function Home () {
  const [search, setSearch] = useState('')
  const [posts, setPosts] = useState<PostCollection[]>([])
  const [upcomingPosts, setUpcomingPosts] = useState<PostCollection[]>([])
  const [lastPost, setLastPost] = useState<QueryDocumentSnapshot<DocumentData>>()
  const [isSincronized, setIsSincronized] = useState(true)
  const [loading, setLoading] = useState(false)
  const auth = useAuth()

  useEffect(() => {
    setLoading(true)
    if (auth.authUser) {
      getLatestPosts().then(({ lastPost, newPosts }) => {
        setPosts(newPosts)
        setLastPost(lastPost)
        setLoading(false)
      })
      const unsub = updatePosts(setUpcomingPosts)
      return () => unsub && unsub()
    }
  }, [auth.authUser])

  useEffect(() => {
    if (upcomingPosts[0]?.id !== posts[0]?.id || upcomingPosts.length !== posts.length) {
      setIsSincronized(false)
    }
  }, [upcomingPosts])

  const handleScroll = (e: SyntheticEvent) => {
    // const { scrollTop, clientHeight, scrollHeight } = e.currentTarget

    // if (scrollTop + clientHeight >= scrollHeight && !loading) {
    //   setLoading(true)
    //   lastPost && loadMore(lastPost).then(({ lastPost, newPosts }) => {
    //     setLastPost(lastPost)
    //     setPosts(prev => [...prev, ...newPosts])
    //     setLoading(false)
    //   })
    // }
  }

  const handleUpdatePosts = () => {
    setPosts(upcomingPosts)
    setIsSincronized(true)
  }

  const handleLoadMore = () => {
    setLoading(true)
    lastPost && loadMore(lastPost).then(({ lastPost, newPosts }) => {
      setLastPost(lastPost)
      setPosts(prev => [...prev, ...newPosts])
      setLoading(false)
    })
  }

  return (
    <>
      <Head>
        <title>Connet</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="logo_ico.ico" />
      </Head>
      <SideBarContainer />
      <main className='relative w-full h-screen'>
        <HeaderMobile search={search} setSearch={setSearch}/>
        {
          !isSincronized && <button className='fixed z-20 bg-dark-green rounded-lg text-ligth-text-green font-concert-one px-2 py-1 w-2/4 left-1/2 transform -translate-x-1/2 top-28' onClick={handleUpdatePosts}>Update</button>
        }
        <section className='flex flex-col gap-4 h-screen overflow-scroll no-scrollbar pb-60 items-center' onScroll={handleScroll}>

          {
            posts && posts.map(post => {
              if (post.content?.toLowerCase().includes(search)) {
                return <PostCard
                post={post}
                key={post.id}
                />
              }
              return undefined
            })
          }

          {
            loading && <Spinner color={'gray'}/>
          }

          {
            (!loading && posts.length > 0) && <button onClick={handleLoadMore} className='bg-dark-green rounded-lg text-ligth-text-green font-concert-one px-2 py-1 w-2/4'>Load More</button>
          }

        </section>

      </main>

      <NavBarMobile />
    </>
  )
}
